vars:
  name: $(basename $(realpath -s .))
  build:
    path: ./cmd/pulse
    goarch: [amd64]

tasks:
  default:
    passthru: true
    steps:
      - task: fmt
      - task: test:gotestsum
      - task: build
      - task: install

  migrate: ../.atkins/schema-migrate.yml

  test:run:
    interactive: true
    env:
      vars:
        PLATFORM_SERVER_ADDR: :3000
        PLATFORM_DB_USER: sqlite://file:${{name}}.run.db
        PLATFORM_DB_PULSE: sqlite://file:${{name}}.run.db
        USER_JWT_SIGNING_KEY: 12345678
        PULSE_AUTH: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJleHAiOjE3NzAxNDQ1NzIsInVzZXJfaWQiOiIwMUtHRlJRR0pKSlg0V1E3MTFGUEJOSlQ0RCJ9.PZSqFP9HwcMmaPFKir_n_EKfoHS9lXJ3s1wSceedhco
    cmds:
      - go run ${{build.path}} --record --duration 1s

  fmt:
    cmds:
      - goimports -w .
      - gofumpt -w .
      - go fmt ./...

  test:
    depends_on: migrate
    cmds:
      - task: test:gotestsum
      - task: test:insert-with-update

  test:gotestsum:
    passthru: true
    tty: true
    cmds:
      - gotestsum ./...

  test:insert-with-update:
    env:
      vars:
        ETL_DB_DSN: "sqlite://file:${{name}}.db"
    cmds:
      - etl query tests/insert-with-update.sql

  build:
    desc: "Build ${{name}}"
    vars:
      goos: linux
    steps:
      - for: goarch in ${{build.goarch}}
        env:
          vars:
            CGO_ENABLED: 0
            GOOS: ${{ goos }}
            GOARCH: ${{ goarch }}
        run: go build -ldflags="-X 'main.Version=${GIT_TAG}' -X 'main.Commit=${GIT_COMMIT}' -X 'main.CommitTime=${GIT_TIME}' -X 'main.Branch=${GIT_BRANCH}' -X 'main.Modified=${GIT_MODIFIED}'" -o bin/${{name}}-${GOOS}-${GOARCH} ${{build.path}}

  install:
    desc: "Install ${{name}}"
    vars:
      goos: linux
    steps:
      - defer: rm -f /usr/local/bin/${{name}}.old
      - cp -f ./bin/${{name}}-${{goos}}-$(dpkg --print-architecture) /usr/local/bin/${{name}}.new
      - mv -f /usr/local/bin/${{name}} /usr/local/bin/${{name}}.old
      - mv -f /usr/local/bin/${{name}}.new /usr/local/bin/${{name}}
