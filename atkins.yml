name: Platform app test pipeline

env:
  include:
    - .env.test

tasks:
  default:
    steps:
      - task: fmt
      - task: test

  migrate:
    passthru: true
    steps:
      - atkins $HOME/.atkins/skills/schema.yml -w ./user migrate
      - atkins $HOME/.atkins/skills/schema.yml -w ./pulse migrate

  fmt:
    desc: "Source code formatting"
    steps:
      - goimports -w -local $(go list .) .
      - goimports-reviser -set-alias -format -imports-order "std,blanked,general,company,project" ./...
      - gofumpt -w .
      - go mod tidy

  test:
    tty: true
    passthru: true
    steps:
      - gotestsum ./... -- -count 1

  pre-commit:
    steps:
      - task: fmt
      - task: test
