@startuml

class "modules.assets.Module" {
  + Mount (_ context.Context, r platform.Router) error
}

class "modules.daily.model.Migrations" {
  + Project: string
  + Filename: string
  + StatementIndex: int64
  + Status: string
  + GetFilename () string
  + GetProject () string
  + GetStatementIndex () int64
  + GetStatus () string
}

interface "modules.daily.model.Storage" {
  + List: List (ctx context.Context) ([]Todo, error)
  + Get: Get (ctx context.Context, id string) (Todo, error)
  + Add: Add (ctx context.Context, t Todo) (Todo, error)
  + Update: Update (ctx context.Context, t Todo) error
  + Complete: Complete (ctx context.Context, id string) error
  + Delete: Delete (ctx context.Context, id string) error
}

class "modules.daily.model.Todo" {
  + ID: string
  + UserID: string
  + Title: string
  + Completed: bool
  + CreatedAt: *time.Time
  + UpdatedAt: *time.Time
  + DeletedAt: *time.Time
  + GetCompleted () bool
  + GetCreatedAt () *time.Time
  + GetDeletedAt () *time.Time
  + GetID () string
  + GetTitle () string
  + GetUpdatedAt () *time.Time
  + GetUserID () string
  + SetCreatedAt (stamp time.Time)
  + SetDeletedAt (stamp time.Time)
  + SetUpdatedAt (stamp time.Time)
}

interface "modules.user.model.SessionStorage" {
  + Create: Create (ctx context.Context, userID string) (*UserSession, error)
  + Get: Get (ctx context.Context, sessionID string) (*UserSession, error)
  + Delete: Delete (ctx context.Context, sessionID string) error
}

class "modules.user.model.User" {
  + ID: string
  + FirstName: string
  + LastName: string
  + DeletedAt: *time.Time
  + CreatedAt: *time.Time
  + UpdatedAt: *time.Time
  + GetCreatedAt () *time.Time
  + GetDeletedAt () *time.Time
  + GetFirstName () string
  + GetID () string
  + GetLastName () string
  + GetUpdatedAt () *time.Time
  + IsActive () bool
  + SetCreatedAt (stamp time.Time)
  + SetDeletedAt (stamp time.Time)
  + SetUpdatedAt (stamp time.Time)
  + String () string
}

class "modules.user.model.UserAuth" {
  + UserID: string
  + Email: string
  + Password: string
  + CreatedAt: *time.Time
  + UpdatedAt: *time.Time
  + GetCreatedAt () *time.Time
  + GetEmail () string
  + GetPassword () string
  + GetUpdatedAt () *time.Time
  + GetUserID () string
  + SetCreatedAt (stamp time.Time)
  + SetUpdatedAt (stamp time.Time)
  + Valid () bool
}

class "modules.user.model.UserGroup" {
  + ID: string
  + Title: string
  + CreatedAt: *time.Time
  + UpdatedAt: *time.Time
  + GetCreatedAt () *time.Time
  + GetID () string
  + GetTitle () string
  + GetUpdatedAt () *time.Time
  + SetCreatedAt (stamp time.Time)
  + SetUpdatedAt (stamp time.Time)
  + String () string
}

class "modules.user.model.UserGroupMember" {
  + UserGroupID: string
  + UserID: string
  + JoinedAt: *time.Time
  + GetJoinedAt () *time.Time
  + GetUserGroupID () string
  + GetUserID () string
  + SetJoinedAt (stamp time.Time)
}

class "modules.user.model.UserSession" {
  + ID: string
  + UserID: string
  + ExpiresAt: *time.Time
  + CreatedAt: *time.Time
  + GetCreatedAt () *time.Time
  + GetExpiresAt () *time.Time
  + GetID () string
  + GetUserID () string
  + SetCreatedAt (stamp time.Time)
  + SetExpiresAt (stamp time.Time)
}

interface "modules.user.model.UserStorage" {
  + Create: Create (context.Context, *User, *UserAuth) (*User, error)
  + Update: Update (context.Context, *User) (*User, error)
  + Get: Get (context.Context, string) (*User, error)
  + GetGroups: GetGroups (context.Context, string) ([]UserGroup, error)
  + Authenticate: Authenticate (ctx context.Context, auth UserAuth) (*User, error)
}

class "modules.user.storage.SessionStorage" {
  - db: *sqlx.DB
  + Create (ctx context.Context, userID string) (*model.UserSession, error)
  + Delete (ctx context.Context, sessionID string) error
  + Get (ctx context.Context, sessionID string) (*model.UserSession, error)
}

class "modules.user.storage.UserStorage" {
  - db: *sqlx.DB
  + Authenticate (ctx context.Context, userAuth model.UserAuth) (*model.User, error)
  + Create (ctx context.Context, u *model.User, userAuth *model.UserAuth) (*model.User, error)
  + Get (ctx context.Context, id string) (*model.User, error)
  + GetGroups (ctx context.Context, userID string) ([]model.UserGroup, error)
  + Update (ctx context.Context, u *model.User) (*model.User, error)
}

class "modules.theme.Link" {
  + Name: string
}

class "modules.theme.Options" {
  + Header: []Link
}

class "modules.user.view.LoginData" {
  + ErrorMessage: string
  + Email: string
}

class "modules.user.view.RegisterData" {
  + ErrorMessage: string
  + Email: string
  + FirstName: string
  + LastName: string
}

class "modules.user.service.Service" {
  + UserStorage: *storage.UserStorage
  + SessionStorage: *storage.SessionStorage
  + Error (r *http.Request, message string, err error)
  + GetError (r *http.Request) string
  + Login (w http.ResponseWriter, r *http.Request)
  + LoginView (w http.ResponseWriter, r *http.Request)
  + Logout (w http.ResponseWriter, r *http.Request)
  + LogoutView (w http.ResponseWriter, r *http.Request)
  + Register (w http.ResponseWriter, r *http.Request)
  + RegisterView (w http.ResponseWriter, r *http.Request)
}

class "modules.user.Handler" {
  + Mount (_ context.Context, r platform.Router) error
  + Name () string
  + Start (ctx context.Context) error
}

class "modules.daily.storage.Storage" {
  - db: *sqlx.DB
  + Add (ctx context.Context, t model.Todo) (model.Todo, error)
  + Complete (ctx context.Context, id string) error
  + Delete (ctx context.Context, id string) error
  + Get (ctx context.Context, id string) (model.Todo, error)
  + List (ctx context.Context) ([]model.Todo, error)
  + Update (ctx context.Context, t model.Todo) error
}

class "modules.daily.view.DailyData" {
  + Tasks: []model.Todo
  + IsLoggedIn: bool
  + SessionUser: *usermodel.User
}

class "modules.daily.Module" {
  - repository: *storage.Storage
  + Mount (_ context.Context, r platform.Router) error
  + Name () string
  + Start (ctx context.Context) error
}

class "modules.email.model.Email" {
  + ID: string
  + Recipient: string
  + Subject: string
  + Body: string
  + Status: string
  + Error: string
  + CreatedAt: *time.Time
  + SentAt: *time.Time
  + RetryCount: int64
  + RetryError: string
  + RetryAt: *time.Time
  + Delete (opts ...QueryOption) string
  + GetBody () string
  + GetCreatedAt () *time.Time
  + GetError () string
  + GetID () string
  + GetRecipient () string
  + GetRetryAt () *time.Time
  + GetRetryCount () int64
  + GetRetryError () string
  + GetSentAt () *time.Time
  + GetStatus () string
  + GetSubject () string
  + Insert (opts ...QueryOption) string
  + Select (opts ...QueryOption) string
  + SetCreatedAt (stamp time.Time)
  + SetRetryAt (stamp time.Time)
  + SetSentAt (stamp time.Time)
  + Update (opts ...QueryOption) string
}

class "modules.email.model.EmailFailed" {
  + ID: string
  + Recipient: string
  + Subject: string
  + Body: string
  + Status: string
  + Error: string
  + CreatedAt: *time.Time
  + SentAt: *time.Time
  + RetryCount: int64
  + RetryError: string
  + RetryAt: *time.Time
  + Delete (opts ...QueryOption) string
  + GetBody () string
  + GetCreatedAt () *time.Time
  + GetError () string
  + GetID () string
  + GetRecipient () string
  + GetRetryAt () *time.Time
  + GetRetryCount () int64
  + GetRetryError () string
  + GetSentAt () *time.Time
  + GetStatus () string
  + GetSubject () string
  + Insert (opts ...QueryOption) string
  + Select (opts ...QueryOption) string
  + SetCreatedAt (stamp time.Time)
  + SetRetryAt (stamp time.Time)
  + SetSentAt (stamp time.Time)
  + Update (opts ...QueryOption) string
}

class "modules.email.model.EmailSent" {
  + ID: string
  + Recipient: string
  + Subject: string
  + Body: string
  + Status: string
  + Error: string
  + CreatedAt: *time.Time
  + SentAt: *time.Time
  + RetryCount: int64
  + RetryError: string
  + RetryAt: *time.Time
  + Delete (opts ...QueryOption) string
  + GetBody () string
  + GetCreatedAt () *time.Time
  + GetError () string
  + GetID () string
  + GetRecipient () string
  + GetRetryAt () *time.Time
  + GetRetryCount () int64
  + GetRetryError () string
  + GetSentAt () *time.Time
  + GetStatus () string
  + GetSubject () string
  + Insert (opts ...QueryOption) string
  + Select (opts ...QueryOption) string
  + SetCreatedAt (stamp time.Time)
  + SetRetryAt (stamp time.Time)
  + SetSentAt (stamp time.Time)
  + Update (opts ...QueryOption) string
}

class "modules.email.model.Migrations" {
  + Project: string
  + Filename: string
  + StatementIndex: int64
  + Status: string
  + Delete (opts ...QueryOption) string
  + GetFilename () string
  + GetProject () string
  + GetStatementIndex () int64
  + GetStatus () string
  + Insert (opts ...QueryOption) string
  + Select (opts ...QueryOption) string
  + Update (opts ...QueryOption) string
}

class "modules.email.model.QueryConfig" {
  + Table: string
  + Columns: []string
  + Where: string
  + OrderBy: string
  + LimitStart: int
  + LimitOffset: int
  + Statement: string
  + Apply (opts ...QueryOption) *QueryConfig
  + WithColumns (cols []string) QueryOption
  + WithLimit (start,offset int) QueryOption
  + WithOrderBy (clause string) QueryOption
  + WithStatement (stmt string) QueryOption
  + WithTable (name string) QueryOption
  + WithWhere (clause string) QueryOption
}

interface "modules.email.model.QueryOption" {
  + WithTable: WithTable (name string) QueryOption
  + WithColumns: WithColumns (cols []string) QueryOption
  + WithWhere: WithWhere (clause string) QueryOption
  + WithOrderBy: WithOrderBy (clause string) QueryOption
  + WithLimit: WithLimit (start,offset int) QueryOption
  + WithStatement: WithStatement (stmt string) QueryOption
}

class "modules.email.smtp.Config" {
  + Host: string
  + Port: int
  + Username: string
  + Password: string
  + From: string
}

class "modules.email.smtp.SMTPSender" {
  - config: Config
  + Send (recipient,subject,body string) error
}

interface "modules.email.smtp.Sender" {
  + Send: Send (recipient,subject,body string) error
}

class "modules.email.storage.EmailStorage" {
  - db: *sqlx.DB
  + Create (ctx context.Context, email *model.Email) error
  + Get (ctx context.Context, id string) (*model.Email, error)
  + GetFailed (ctx context.Context, limit int) ([]model.Email, error)
  + GetPending (ctx context.Context, limit int) ([]model.Email, error)
  + GetSent (ctx context.Context, limit int) ([]model.Email, error)
  + Update (ctx context.Context, email *model.Email) error
}

interface "modules.email.EmailStorage" {
  + Create: Create (ctx context.Context, email *model.Email) error
  + Get: Get (ctx context.Context, id string) (*model.Email, error)
  + GetPending: GetPending (ctx context.Context, limit int) ([]model.Email, error)
  + Update: Update (ctx context.Context, email *model.Email) error
}

class "modules.email.Handler" {
  - service: *Service
  + Mount (_ context.Context, r platform.Router) error
  + Name () string
  + Start (ctx context.Context) error
  + Stop (ctx context.Context) error
}

class "modules.email.Service" {
  - emailStorage: EmailStorage
  - sender: smtp.Sender
  - queue: chan *model.Email
  - wg: sync.WaitGroup
  - ctx: context.Context
  - cancel: context.CancelFunc
  - ticker: *time.Ticker
  - options: ServiceOptions
  - logger: *slog.Logger
  + AddEmail (ctx context.Context, email *model.Email) error
  + Start ()
  + Stop ()
}

class "modules.email.ServiceOptions" {
  + MaxRetries: int64
  + RetryDuration: time.Duration
  + TickerInterval: time.Duration
  + QueueCapacity: int64
  + Logger: *slog.Logger
}

class "modules.expvar.Handler" {
  + Enabled: bool
  + Mount (_ context.Context, r platform.Router) error
  + Start (context.Context) error
}

class "modules.user.cmd.generate.Config" {
  + Features: map[string]any
  + Flows: map[string]Flow
}

class "modules.user.cmd.generate.Flow" {
  + Steps: []Step
}

class "modules.user.cmd.generate.Step" {
  + Name: string
  + View: string
  + Link: string
  + EnabledIf: string
  + Next: map[string]string
}













"modules.user.storage.SessionStorage" --> "modules.user.model.UserSession" : .Create()
"modules.user.storage.SessionStorage" --> "modules.user.model.UserSession" : .Get()

"modules.user.storage.UserStorage" --> "modules.user.model.User" : .Authenticate()
"modules.user.storage.UserStorage" --> "modules.user.model.User" : .Create()
"modules.user.storage.UserStorage" --> "modules.user.model.User" : .Get()
"modules.user.storage.UserStorage" --> "modules.user.model.UserGroup" : .GetGroups()
"modules.user.storage.UserStorage" --> "modules.user.model.User" : .Update()

"modules.theme.Options" --> "modules.theme.Link" : .Header



"modules.user.service.Service" --> "modules.user.storage.UserStorage" : .UserStorage
"modules.user.service.Service" --> "modules.user.storage.SessionStorage" : .SessionStorage

"modules.user.Handler" --|> "modules.user.service.Service" : embeds


"modules.daily.storage.Storage" --> "modules.daily.model.Todo" : .Add()
"modules.daily.storage.Storage" --> "modules.daily.model.Todo" : .Get()
"modules.daily.storage.Storage" --> "modules.daily.model.Todo" : .List()
"modules.daily.storage.Storage" --> "modules.daily.model.Todo" : .Update()
"modules.daily.view.DailyData" --> "modules.daily.model.Todo" : .Tasks
"modules.daily.view.DailyData" --> "modules.user.model.User" : .SessionUser

"modules.daily.Module" --> "modules.daily.storage.Storage" : .repository








"modules.email.smtp.SMTPSender" --> "modules.email.smtp.Config" : .config



"modules.email.storage.EmailStorage" --> "modules.email.model.Email" : .Create()
"modules.email.storage.EmailStorage" --> "modules.email.model.Email" : .Get()
"modules.email.storage.EmailStorage" --> "modules.email.model.Email" : .GetFailed()
"modules.email.storage.EmailStorage" --> "modules.email.model.Email" : .GetPending()
"modules.email.storage.EmailStorage" --> "modules.email.model.Email" : .GetSent()
"modules.email.storage.EmailStorage" --> "modules.email.model.Email" : .Update()

"modules.email.Handler" --> "modules.email.Service" : .service

"modules.email.Service" --> "modules.email.EmailStorage" : .emailStorage
"modules.email.Service" --> "modules.email.smtp.Sender" : .sender
"modules.email.Service" --> "modules.email.ServiceOptions" : .options

"modules.email.Service" --> "modules.email.model.Email" : .AddEmail()
"modules.email.Service" --> "modules.email.model.Email" : .sendEmail()


"modules.user.cmd.generate.Config" --> "modules.user.cmd.generate.any" : .Features
"modules.user.cmd.generate.Config" --> "modules.user.cmd.generate.Flow" : .Flows

"modules.user.cmd.generate.Flow" --> "modules.user.cmd.generate.Step" : .Steps



@enduml
