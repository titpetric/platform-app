---
version: "3"

# Setup GOTOOLCHAIN workaround for #75031:
# https://github.com/golang/go/issues/75031#issuecomment-3195256688

vars:
  name: app
  goversion:
    sh: go env GOVERSION
  toolchain: '{{.goversion}}+auto'

tasks:
  default:
    desc: "Run platform base"
    env:
      PLATFORM_SERVER_ADDR: ":0"
      PLATFORM_DB_DEFAULT: "mysql://platform:platform@tcp(127.0.0.1:3306)/platform"
      PLATFORM_DB_USER: "mysql://platform:platform@tcp(127.0.0.1:3306)/platform"
      PLATFORM_ENABLE_EXPVAR: "true"
    cmds:
      - task: fmt
      - CGO_ENABLED=0 go run ./cmd/{{.name}}

  fmt:
    desc: "Source code formatting"
    cmds:
      - goimports-reviser -rm-unused -set-alias -format ./...
      - gofumpt -w .
      - go mod tidy

  gen:
    desc: "Generate code"
    cmds:
      - templ generate

  docker:
    desc: "Build docker image"
    cmds:
      - defer: rm platform -f
      - CGO_ENABLED=0 go build ./cmd/{{.name}}
      - docker build --no-cache -t internal/{{.name}} -f docker/Dockerfile .

  clean:
    desc: "Clean build assets"
    cmds:
      - task: fmt
      - go clean -cache
      - go clean -testcache
      - rm -f ./{{.name}} pkg.cov go-fsck.json
      - docker rmi -f internal/{{.name}}

  migrate:
    desc: "Run migrations"
    cmds:
      - mig lint --db-dsn="platform:platform@tcp(127.0.0.1:3306)/platform" --schema platform
      - mig docs --db-dsn="platform:platform@tcp(127.0.0.1:3306)/platform" --schema platform --output=./user/docs
      - mig gen --db-dsn="platform:platform@tcp(127.0.0.1:3306)/platform" --go.skip-json --schema platform --output=./user/model

  bench:
    desc: "Run benchmarks"
    env:
      GOTOOLCHAIN: '{{.toolchain}}'
    cmd: go test -failfast -run='Bench.+' -bench=. -benchmem -cpu 1,2,4 -race -v ./...

  test:
    desc: "Run tests and collect coverage"
    env:
      GOTOOLCHAIN: '{{.toolchain}}'
      PLATFORM_ENABLE_EXPVAR: "true"
      PLATFORM_ENABLE_OTEL: "true"
    cmds:
      - task: fmt
      - go test -failfast -race -count=1 -cover -coverpkg=./... -coverprofile=pkg.cov ./...

  integration:
    desc: "Run integration tests"
    vars:
      tags: integration
    env:
      GOTOOLCHAIN: '{{.toolchain}}'
      PLATFORM_ENABLE_EXPVAR: "true"
      PLATFORM_ENABLE_OTEL: "true"
      PLATFORM_DB_DEFAULT: "mysql://platform:platform@tcp(127.0.0.1:3306)/platform"
      PLATFORM_DB_USER: "mysql://platform:platform@tcp(127.0.0.1:3306)/platform"
    cmds:
      - task: fmt
      - go test -tags '{{.tags}}' -failfast -race -count=1 -cover -coverpkg=./... -coverprofile=pkg.cov ./...

  cover:
    desc: "Show source coverage"
    cmds:
      - defer: rm -f pkg.cov.json
      - go tool cover -func=pkg.cov | summary coverfunc --json > pkg.cov.json
      - go-fsck extract ./...
      - go-fsck coverage -c pkg.cov.json -o go-fsck.json
      - go-fsck coverage --template=docs/testing-coverage.md.tpl -v > docs/testing-coverage.md
      - perl -pi -e 's/github.com\/titpetric/titpetric/g' docs/testing-coverage.md

  uncover:
    desc: "Show uncovered source"
    cmd: uncover pkg.cov

  setup:
    desc: "Install dev tooling"
    env:
      GOBIN: /usr/local/bin
    cmds:
      - go install github.com/gregoryv/uncover/...@latest
      - go install mvdan.cc/gofumpt@latest
      - go install -v github.com/incu6us/goimports-reviser/v3@latest

  up:
    desc: "Bring up docker env"
    cmd: docker compose up -d --remove-orphans --wait

  down:
    desc: "Bring down docker env"
    cmd: docker compose down
